<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #btnToggleOtherDetails:hover {
            background: #6b2d87 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 45, 135, 0.2);
        }
        #btnToggleCardBreakdown:hover {
            background: #6b2d87 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 45, 135, 0.2);
        }
        #btnToggleFinancing:hover {
            background: #6b2d87 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 45, 135, 0.2);
        }
    </style>
</head>
<body>
        <div class="container">
        <div style="text-align:center;margin-bottom:20px;">
            <img src="logo.png" alt="Logo" style="height:65px;width:auto;">
        </div>
        <div class="header-with-button">
            <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
            <a href="reports.html" class="btn-reports">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        </div>

        <div class="card" id="loginCard" style="margin-bottom:20px;padding:16px;border:1px solid #e0e0e0;border-radius:12px;background:#f8f9fa;">
            <h3 style="margin-bottom:12px;color:#6b2d87;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù</h3>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <input type="text" id="loginEmployeeId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" style="flex:1;min-width:160px;padding:10px;border:2px solid #e0e0e0;border-radius:10px;">
                <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="flex:1;min-width:160px;padding:10px;border:2px solid #e0e0e0;border-radius:10px;">
                <button id="btnLogin" style="flex:0 0 auto;padding:12px 16px;background:#6b2d87;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:600;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
            <div id="loginStatus" style="margin-top:10px;color:#ff0404;font-weight:600;">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</div>
        </div>

        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
        <div id="welcomeCard" class="card" style="display:none;margin-bottom:20px;padding:16px;background:#6b2d87;border-radius:12px;border:none;color:white;">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
                <div>
                    <h2 style="margin:0;margin-bottom:8px;font-size:24px;">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ <span id="welcomeUserName" style="font-weight:700;color:#ffd700;"></span></h2>
                    <p style="margin:0;font-size:14px;opacity:0.9;">ğŸ¢ Ø§Ù„ÙØ±Ø¹: <strong id="welcomeUserBranch" style="font-weight:600;"></strong></p>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <a id="btnAdminLink" href="admin.html" class="btn-reports" style="display:none;background:#28a745;padding:10px 16px;text-decoration:none;border-radius:8px;color:white;font-weight:600;cursor:pointer;transition:transform 0.2s;">âš™ï¸ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
                    <button id="btnLogoutWelcome" style="padding:10px 16px;background:#d32f2f;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>

        <div id="secureArea" style="display:none;">
        <form id="salesForm">
            <div class="form-group" style="display:none;">
                <label for="employeeId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                <input type="text" id="employeeId" name="employeeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
            </div>

            <div class="form-group" style="display:none;">
                <label for="branch">Ø§Ù„ÙØ±Ø¹</label>
                <input type="text" id="branch" name="branch" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹" required>
            </div>

            <div class="form-group">
                <label for="saleDate" style="font-size:16px;font-weight:bold;color:#2c3e50;">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="saleDate" name="saleDate" required style="padding:14px;font-size:16px;border:3px solid #3498db;border-radius:10px;background:#e8f4fc;color:#2c3e50;font-weight:600;cursor:pointer;">
            </div>

            <div class="form-group">
                <label for="totalSales">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</label>
                <input type="number" id="totalSales" name="totalSales" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª" required>
            </div>

            

            <div class="form-group">
                <label for="totalCard">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©</label>
                <input type="number" id="totalCard" name="totalCard" step="0.01" placeholder="Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly required>
                <button type="button" id="btnToggleCardBreakdown" style="width:100%;margin-top:10px;padding:12px 20px;background:transparent;color:#6b2d87;border:2px solid #6b2d87;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:all 0.3s;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©</button>
                <small style="color:#666;display:block;margin-top:6px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ÙØªØ­/Ø·ÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©</small>
            </div>

            <div id="cardBreakdownGroup" style="display:none;background:#f7fbff;padding:16px;border-radius:12px;border:2px solid #b3d9ff;margin:10px 0;">
                <div class="form-group">
                    <label for="visaSales">Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠØ²Ø§</label>
                    <input type="number" id="visaSales" name="visaSales" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠØ²Ø§" value="">
                </div>

                <div class="form-group">
                    <label for="masterSales">Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø§Ø³ØªØ± ÙƒØ§Ø±Ø¯</label>
                    <input type="number" id="masterSales" name="masterSales" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø§Ø³ØªØ± ÙƒØ§Ø±Ø¯" value="">
                </div>

                <div class="form-group">
                    <label for="madaSales">Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø¯Ù‰</label>
                    <input type="number" id="madaSales" name="madaSales" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø¯Ù‰" value="">
                </div>
            </div>
             <div class="form-group">
                <label for="totalCash">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                <input type="number" id="totalCash" name="totalCash" step="0.01" placeholder="Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly required>
            </div>

           

    

            <div class="form-group">
                <label for="extraCash">ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯</label>
                <input type="number" id="extraCash" name="extraCash" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø²Ø§Ø¦Ø¯" value="">
            </div>

            <div class="form-group">
                <button type="button" id="btnToggleOtherDetails" style="width:100%;padding:12px 20px;background:transparent;color:#6b2d87;border:2px solid #6b2d87;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:all 0.3s;">ØªÙØ§ØµÙŠÙ„ Ø£Ø®Ø±Ù‰ (Ù…ØµØ±ÙˆÙØ§Øª --Ù…Ø±Ø¯ÙˆØ¯--Ø§Ù„Ø®)</button>
            </div>

            <div id="otherDetailsGroup" style="display:none;background:#f9f7ff;padding:16px;border-radius:12px;border:2px solid #d6ccff;margin:10px 0;">
                <div class="form-group">
                    <label for="expenses">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</label>
                    <input type="number" id="expenses" name="expenses" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª" value="">
                </div>

                <div class="form-group" id="expenseNotesGroup" style="display: none;">
                    <label for="expenseNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª <span style="color: red;">*</span></label>
                    <textarea id="expenseNotes" name="expenseNotes" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª..."></textarea>
                </div>

                <div class="form-group">
                    <label for="returns">Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯</label>
                    <input type="number" id="returns" name="returns" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯" value="">
                </div>

                <div class="form-group" id="returnsNotesGroup" style="display: none;">
                    <label for="returnsNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯ <span style="color: red;">*</span></label>
                    <textarea id="returnsNotes" name="returnsNotes" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯..."></textarea>
                </div>

                <div class="form-group">
                    <label for="withdrawal">Ø§Ù„Ø³Ø­Ø¨ Ø§Ùˆ Ø¹Ø¬Ø²</label>
                    <input type="number" id="withdrawal" name="withdrawal" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø­Ø¨" value="">
                </div>

                <div class="form-group" id="withdrawalNotesGroup" style="display: none;">
                    <label for="withdrawalNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø¹Ø¬Ø² <span style="color: red;">*</span></label>
                    <textarea id="withdrawalNotes" name="withdrawalNotes" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø£Ùˆ Ø§Ù„Ø¹Ø¬Ø²..."></textarea>
                </div>
            </div>
             <div class="form-group">
                <button type="button" id="btnToggleFinancing" style="width:100%;padding:12px 20px;background:transparent;color:#6b2d87;border:2px solid #6b2d87;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:all 0.3s;">ğŸ’³ ØªØ§Ø¨ÙŠ -- ØªÙ…Ø§Ø±Ø§ - ØªÙ…ÙˆÙŠÙ„ </button>
            </div>
            <div id="financingGroup" style="display:none;background:#f0f8ff;padding:20px;border-radius:12px;border:2px solid #17a2b8;margin:10px 0;">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #17a2b8;">
                    <img src="financing-icon.svg" alt="ØªÙ…ÙˆÙŠÙ„" style="width:48px;height:48px;">
                    <h3 style="margin:0;color:#17a2b8;font-size:20px;font-weight:bold;">Ù‚Ø³Ù… Ø§Ù„ØªÙ…ÙˆÙŠÙ„</h3>
                </div>
                
                <div class="form-group">
                    <label for="tamara">ØªÙ…Ø§Ø±Ø§</label>
                    <input type="number" id="tamara" name="tamara" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ ØªÙ…Ø§Ø±Ø§" value="">
                </div>

                <div class="form-group">
                    <label for="tabby">ØªØ§Ø¨ÙŠ</label>
                    <input type="number" id="tabby" name="tabby" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ ØªØ§Ø¨ÙŠ" value="">
                </div>

                <div class="form-group" id="financingNotesGroup" style="display: none;">
                    <label for="financingNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ) <span style="color: red;">*</span></label>
                    <textarea id="financingNotes" name="financingNotes" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† ØªÙ…Ø§Ø±Ø§ Ø£Ùˆ ØªØ§Ø¨ÙŠ..."></textarea>
                </div>
            </div>
           
            <div class="form-group">
                <label for="imageUpload">ğŸ“¸ Ø±ÙØ¹ ØµÙˆØ±Ø©</label>
                <input type="file" id="imageUpload" name="imageUpload" accept="image/jpeg,image/png,image/jpg,image/gif,image/webp" style="width:100%;padding:10px;border:2px dashed #e0e0e0;border-radius:10px;background:#f9f9f9;cursor:pointer;">
                <small style="color:#666;display:block;margin-top:8px;">Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: JPG, PNG, GIF, WEBP (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 5MB)</small>
                <div id="imagePreview" style="margin-top:15px;display:none;">
                    <img id="previewImg" style="max-width:100%;max-height:300px;border-radius:8px;border:2px solid #4caf50;" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
                    <p id="imageName" style="color:#666;margin-top:8px;font-size:12px;"></p>
                    <button type="button" id="btnRemoveImage" style="margin-top:8px;padding:6px 12px;background:#f44336;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">âŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button>
                </div>
                <input type="hidden" id="attachment" name="attachment">
                <input type="hidden" id="attachmentURL" name="attachmentURL">
            </div>

            <div class="btn-group">
                <button type="submit" class="btn-submit">Ø­ÙØ¸</button>
                <button type="reset" class="btn-reset">Ù…Ø³Ø­</button>
            </div>
        </form>

        <div class="result" id="result">
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</span>
                <span class="result-value" id="displayEmployeeId">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„ÙØ±Ø¹:</span>
                <span class="result-value" id="displayBranch">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                <span class="result-value" id="displaySales">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´:</span>
                <span class="result-value" id="displayCash">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ:</span>
                <span class="result-value" id="displayCard">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span>
                <span class="result-value" id="displayExpenses">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯:</span>
                <span class="result-value" id="displayReturns">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ø³Ø­Ø¨:</span>
                <span class="result-value" id="displayWithdrawal">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
                <span class="result-value" id="displayNotes">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚:</span>
                <span class="result-value" id="displayAttachment">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                <span class="result-value" id="displayTotal">0</span>
            </div>
        </div>
    </div>
    </div>

    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const supabaseUrl = 'https://rgblfimktfasocahzqtg.supabase.co'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù€ URL Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnYmxmaW1rdGZhc29jYWh6cXRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDg5NTQsImV4cCI6MjA4NTUyNDk1NH0.BMKXS1hTX5ntacnOQH5c2I5KDp5jpSWwJeHIDkz2els';
         const supabase = createClient(supabaseUrl, supabaseAnonKey);

        const form = document.getElementById('salesForm');
        const result = document.getElementById('result');
        const expensesInput = document.getElementById('expenses');
        const expenseNotesGroup = document.getElementById('expenseNotesGroup');
        const expenseNotesInput = document.getElementById('expenseNotes');
        const returnsNotesGroup = document.getElementById('returnsNotesGroup');
        const returnsNotesInput = document.getElementById('returnsNotes');
        const withdrawalNotesGroup = document.getElementById('withdrawalNotesGroup');
        const withdrawalNotesInput = document.getElementById('withdrawalNotes');

        const loginEmployeeId = document.getElementById('loginEmployeeId');
        const loginPassword = document.getElementById('loginPassword');
        const btnLogin = document.getElementById('btnLogin');
        const loginStatus = document.getElementById('loginStatus');
        const loginCard = document.getElementById('loginCard');
        const secureArea = document.getElementById('secureArea');
        const welcomeCard = document.getElementById('welcomeCard');
        const btnLogoutWelcome = document.getElementById('btnLogoutWelcome');
        let currentEmployee = null;

        const totalSalesInput = document.getElementById('totalSales');
        const totalCardInput = document.getElementById('totalCard');
        const visaSalesInput = document.getElementById('visaSales');
        const masterSalesInput = document.getElementById('masterSales');
        const madaSalesInput = document.getElementById('madaSales');
        const cardBreakdownGroup = document.getElementById('cardBreakdownGroup');
        const btnToggleCardBreakdown = document.getElementById('btnToggleCardBreakdown');
        const otherDetailsGroup = document.getElementById('otherDetailsGroup');
        const btnToggleOtherDetails = document.getElementById('btnToggleOtherDetails');
        const tamaraInput = document.getElementById('tamara');
        const tabbyInput = document.getElementById('tabby');
        const extraCashInput = document.getElementById('extraCash');
        const returnsInput = document.getElementById('returns');
        const withdrawalInput = document.getElementById('withdrawal');
        const totalCashInput = document.getElementById('totalCash');
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª
        const imageUploadInput = document.getElementById('imageUpload');
        const imagePreviewDiv = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const imageName = document.getElementById('imageName');
        const btnRemoveImage = document.getElementById('btnRemoveImage');
        const attachmentInput = document.getElementById('attachment');
        const attachmentURLInput = document.getElementById('attachmentURL');
        
        let uploadedImageFile = null;
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„
        const btnToggleFinancing = document.getElementById('btnToggleFinancing');
        const financingGroup = document.getElementById('financingGroup');
        const financingNotesGroup = document.getElementById('financingNotesGroup');
        const financingNotesInput = document.getElementById('financingNotes');

        function calculateCash() {
            const totalSales = parseFloat(totalSalesInput.value) || 0;
            const totalCard = parseFloat(totalCardInput.value) || 0;
            const tamara = parseFloat(tamaraInput.value) || 0;
            const tabby = parseFloat(tabbyInput.value) || 0;
            const extraCash = parseFloat(extraCashInput.value) || 0;
            const expenses = parseFloat(expensesInput.value) || 0;
            const withdrawal = parseFloat(withdrawalInput.value) || 0;
            const returns = parseFloat(returnsInput.value) || 0;

            const cash = totalSales - totalCard - tamara - tabby - expenses - withdrawal - returns + extraCash;
            totalCashInput.value = cash.toFixed(2);
        }

        function updateTotalCardFromBreakdown() {
            const visa = parseFloat(visaSalesInput.value) || 0;
            const master = parseFloat(masterSalesInput.value) || 0;
            const mada = parseFloat(madaSalesInput.value) || 0;
            const totalCard = visa + master + mada;
            totalCardInput.value = totalCard.toFixed(2);
            calculateCash();
        }

        function toggleCardBreakdown(forceOpen) {
            if (!cardBreakdownGroup) return;
            const isOpen = cardBreakdownGroup.style.display !== 'none';
            const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : !isOpen;
            cardBreakdownGroup.style.display = shouldOpen ? 'block' : 'none';
        }

        function toggleOtherDetails(forceOpen) {
            if (!otherDetailsGroup) return;
            const isOpen = otherDetailsGroup.style.display !== 'none';
            const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : !isOpen;
            otherDetailsGroup.style.display = shouldOpen ? 'block' : 'none';
        }

        totalSalesInput.addEventListener('input', calculateCash);
        totalCardInput.addEventListener('input', calculateCash);
        visaSalesInput.addEventListener('input', updateTotalCardFromBreakdown);
        masterSalesInput.addEventListener('input', updateTotalCardFromBreakdown);
        madaSalesInput.addEventListener('input', updateTotalCardFromBreakdown);
        tamaraInput.addEventListener('input', calculateCash);
        tabbyInput.addEventListener('input', calculateCash);
        extraCashInput.addEventListener('input', calculateCash);

        if (btnToggleCardBreakdown) {
            btnToggleCardBreakdown.addEventListener('click', function() {
                toggleCardBreakdown();
            });
        }

        if (btnToggleOtherDetails) {
            btnToggleOtherDetails.addEventListener('click', function() {
                toggleOtherDetails();
            });
        }

        totalCardInput.addEventListener('click', function() {
            toggleCardBreakdown(true);
        });

        function checkFinancingNotes() {
            const tamaraValue = parseFloat(tamaraInput.value) || 0;
            const tabbyValue = parseFloat(tabbyInput.value) || 0;
            if (tamaraValue > 0 || tabbyValue > 0) {
                financingNotesGroup.style.display = 'block';
                financingNotesInput.setAttribute('required', 'required');
            } else {
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                financingNotesInput.value = '';
            }
        }

        tamaraInput.addEventListener('input', checkFinancingNotes);
        tabbyInput.addEventListener('input', checkFinancingNotes);

        let withdrawalAlertShown = false;

        btnToggleFinancing.addEventListener('click', function() {
            if (financingGroup.style.display === 'none') {
                financingGroup.style.display = 'block';
                btnToggleFinancing.textContent = 'ğŸ’³ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ…ÙˆÙŠÙ„';
            } else {
                financingGroup.style.display = 'none';
                btnToggleFinancing.textContent = 'ğŸ’³ ØªÙ…ÙˆÙŠÙ„';
                tamaraInput.value = '0';
                tabbyInput.value = '0';
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                financingNotesInput.value = '';
                calculateCash();
            }
        });
        expensesInput.addEventListener('input', function() {
            calculateCash();
            const expensesValue = parseFloat(this.value) || 0;
            if (expensesValue > 0) {
                expenseNotesGroup.style.display = 'block';
                expenseNotesInput.setAttribute('required', 'required');
            } else {
                expenseNotesGroup.style.display = 'none';
                expenseNotesInput.removeAttribute('required');
                expenseNotesInput.value = '';
            }
        });

        returnsInput.addEventListener('input', function() {
            calculateCash();
            const returnsValue = parseFloat(this.value) || 0;
            if (returnsValue > 0) {
                returnsNotesGroup.style.display = 'block';
                returnsNotesInput.setAttribute('required', 'required');
            } else {
                returnsNotesGroup.style.display = 'none';
                returnsNotesInput.removeAttribute('required');
                returnsNotesInput.value = '';
            }
        });
        withdrawalInput.addEventListener('input', function() {
            calculateCash();
            const withdrawalValue = parseFloat(this.value) || 0;
            if (withdrawalValue > 0) {
                withdrawalNotesGroup.style.display = 'block';
                withdrawalNotesInput.setAttribute('required', 'required');
            } else {
                withdrawalNotesGroup.style.display = 'none';
                withdrawalNotesInput.removeAttribute('required');
                withdrawalNotesInput.value = '';
            }

            if (withdrawalValue > 0 && !withdrawalAlertShown) {
                alert('âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¨Ù„ÙŠØº Ù…Ø¯ÙŠØ±Ùƒ Ø¨Ø§Ù„Ù…Ø¨Ù„Øº');
                withdrawalAlertShown = true;
            }
        });

        async function saveToSupabase(recordData) {
            try {
                console.log('Attempting to insert record:', recordData);
                const insertData = {
                    employee_id: recordData.employeeId,
                    branch: recordData.branch,
                    sale_date: recordData.saleDate,
                    total_sales: recordData.totalSales,
                    total_cash: recordData.totalCash,
                    total_card: recordData.totalCard,
                    tamara: recordData.tamara,
                    tabby: recordData.tabby,
                    extra_cash: recordData.extraCash,
                    expenses: recordData.expenses,
                    returns: recordData.returns,
                    withdrawal: recordData.withdrawal,
                    notes: recordData.notes,
                    financing_notes: recordData.financingNotes,
                    attachment: recordData.attachment,
                    created_at: new Date().toISOString()
                };
                
                // Ø£Ø¶Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ù‡Ø§ Ù‚ÙŠÙ…Ø©
                if (recordData.visaSales && recordData.visaSales > 0) {
                    insertData.visa_sales = recordData.visaSales;
                }
                if (recordData.masterSales && recordData.masterSales > 0) {
                    insertData.master_sales = recordData.masterSales;
                }
                if (recordData.madaSales && recordData.madaSales > 0) {
                    insertData.mada_sales = recordData.madaSales;
                }
                
                const { data, error } = await supabase
                    .from('sales')
                    .insert([insertData]);
                
                if (error) {
                    console.error('Supabase error details:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    throw error;
                }
                
                console.log('Insert successful:', data);
            } catch (err) {
                console.error('Save to Supabase failed:', err);
                throw err;
            }
        }

        function setFormEnabled(enabled) {
            const controls = Array.from(form.elements).filter(el => el.id !== 'loginEmployeeId' && el.id !== 'loginPassword' && el.id !== 'btnLogin');
            controls.forEach(el => { el.disabled = !enabled; });
        }

        btnLogin.addEventListener('click', handleLogin);
        
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        loginEmployeeId.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                btnLogin.click();
            }
        });
        
        loginPassword.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                btnLogin.click();
            }
        });
        
        setFormEnabled(false);
        secureArea.style.display = 'none';

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentEmployee) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸');
                return;
            }

            const employeeId = document.getElementById('employeeId').value;
            const branch = document.getElementById('branch').value;
            const saleDate = document.getElementById('saleDate').value;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            if (!employeeId || !branch || !saleDate) {
                alert('âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù†Ø§Ù‚ØµØ©:\n- Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù: ' + (employeeId ? 'âœ…' : 'âŒ') + 
                      '\n- Ø§Ù„ÙØ±Ø¹: ' + (branch ? 'âœ…' : 'âŒ') + 
                      '\n- Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + (saleDate ? 'âœ…' : 'âŒ'));
                return;
            }
            
            const totalSales = parseFloat(document.getElementById('totalSales').value) || 0;
            const totalCash = parseFloat(document.getElementById('totalCash').value) || 0;
            const totalCard = parseFloat(document.getElementById('totalCard').value) || 0;
            const tamara = parseFloat(document.getElementById('tamara').value) || 0;
            const tabby = parseFloat(document.getElementById('tabby').value) || 0;
            const extraCash = parseFloat(document.getElementById('extraCash').value) || 0;
            const expenses = parseFloat(document.getElementById('expenses').value) || 0;
            
            if ((tamara > 0 || tabby > 0) && !document.getElementById('financingNotes').value.trim()) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (ØªÙ…Ø§Ø±Ø§/ØªØ§Ø¨ÙŠ)');
                document.getElementById('financingNotes').focus();
                return;
            }
            
            const returns = parseFloat(document.getElementById('returns').value) || 0;
            const withdrawal = parseFloat(document.getElementById('withdrawal').value) || 0;
            const expenseNotes = expenseNotesInput.value.trim();
            const returnsNotes = returnsNotesInput.value.trim();
            const withdrawalNotes = withdrawalNotesInput.value.trim();

            if (expenses > 0 && !expenseNotes) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');
                expenseNotesInput.focus();
                return;
            }

            if (returns > 0 && !returnsNotes) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯');
                returnsNotesInput.focus();
                return;
            }

            if (withdrawal > 0 && !withdrawalNotes) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø¹Ø¬Ø²');
                withdrawalNotesInput.focus();
                return;
            }
            const notesParts = [];
            if (expenses > 0) notesParts.push(`Ù…ØµØ±ÙˆÙØ§Øª: ${expenseNotes}`);
            if (returns > 0) notesParts.push(`Ù…Ø±Ø¯ÙˆØ¯: ${returnsNotes}`);
            if (withdrawal > 0) notesParts.push(`Ø³Ø­Ø¨/Ø¹Ø¬Ø²: ${withdrawalNotes}`);
            const notes = notesParts.length ? notesParts.join(' | ') : '-';
            const attachment = '';

            const total = totalCash + totalCard;

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            let confirmMessage = '===== Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª =====\n\n';
            confirmMessage += 'Ø§Ù„ÙØ±Ø¹: ' + branch + '\n';
            confirmMessage += 'Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + saleDate + '\n';
            confirmMessage += 'Ø§Ù„Ù…ÙˆØ¸Ù: ' + employeeId + '\n';
            confirmMessage += '----------------------------\n';
            confirmMessage += 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ' + totalSales.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            confirmMessage += 'Ø§Ù„ÙƒØ§Ø´: ' + totalCash.toFixed(2) + ' Ø±ÙŠØ§Ù„ **\n';
            confirmMessage += 'Ù…Ø¯ÙŠ: ' + totalCard.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (tamara > 0) confirmMessage += 'ØªÙ…Ø§Ø±Ø§: ' + tamara.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (tabby > 0) confirmMessage += 'ØªØ§Ø¨ÙŠ: ' + tabby.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (extraCash > 0) confirmMessage += 'ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯: ' + extraCash.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (expenses > 0) confirmMessage += 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ' + expenses.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (returns > 0) confirmMessage += 'Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯: ' + returns.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (withdrawal > 0) confirmMessage += 'Ø§Ù„Ø³Ø­Ø¨: ' + withdrawal.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            confirmMessage += '----------------------------\n';
            confirmMessage += 'Ù‡Ù„ ØªØ¤ÙƒØ¯ Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ';

            console.log('Showing confirmation dialog...');
            const userConfirmed = confirm(confirmMessage);
            console.log('User confirmation:', userConfirmed);
            
            if (!userConfirmed) {
                console.log('User cancelled, not saving');
                return;
            }

            console.log('User confirmed, proceeding to save...');

            document.getElementById('displayEmployeeId').textContent = employeeId;
            document.getElementById('displayBranch').textContent = branch;
            document.getElementById('displaySales').textContent = totalSales.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayCash').textContent = totalCash.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayCard').textContent = totalCard.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayExpenses').textContent = expenses.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayReturns').textContent = returns.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayWithdrawal').textContent = withdrawal.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayNotes').textContent = notes;
            document.getElementById('displayAttachment').textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            document.getElementById('displayTotal').textContent = total.toFixed(2) + ' Ø±ÙŠØ§Ù„';

            // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            let attachmentURL = '-';
            let attachmentFileName = '-';
            
            if (uploadedImageFile) {
                try {
                    console.log('Uploading image first...');
                    document.getElementById('displayAttachment').textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...';
                    
                    const uploadResult = await uploadImageToSupabase(uploadedImageFile);
                    attachmentURL = uploadResult.url;
                    attachmentFileName = uploadResult.fileName;
                    
                    console.log('Image uploaded:', uploadResult);
                    document.getElementById('displayAttachment').textContent = `âœ… ${uploadResult.fileName}`;
                } catch (error) {
                    console.error('Failed to upload image:', error);
                    alert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                    return;
                }
            }

            const recordData = {
                employeeId,
                branch,
                saleDate,
                totalSales,
                totalCash,
                totalCard,
                visaSales: parseFloat(visaSalesInput.value) || 0,
                masterSales: parseFloat(masterSalesInput.value) || 0,
                madaSales: parseFloat(madaSalesInput.value) || 0,
                tamara,
                tabby,
                extraCash,
                expenses,
                returns,
                withdrawal,
                notes,
                financingNotes: document.getElementById('financingNotes').value || '-',
                attachment: attachmentURL
            };

            try {
                console.log('Attempting to save to Supabase...', recordData);
                await saveToSupabase(recordData);
                console.log('Save successful!');
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase Ø¨Ù†Ø¬Ø§Ø­!');
                result.classList.add('show');
                form.reset();
                
                // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
                uploadedImageFile = null;
                imagePreviewDiv.style.display = 'none';
                previewImg.src = '';
                imageName.textContent = '';
                attachmentInput.value = '';
                attachmentURLInput.value = '';
                
                withdrawalAlertShown = false;
                expenseNotesGroup.style.display = 'none';
                expenseNotesInput.removeAttribute('required');
                expenseNotesInput.value = '';
                returnsNotesGroup.style.display = 'none';
                returnsNotesInput.removeAttribute('required');
                returnsNotesInput.value = '';
                withdrawalNotesGroup.style.display = 'none';
                withdrawalNotesInput.removeAttribute('required');
                withdrawalNotesInput.value = '';
                financingGroup.style.display = 'none';
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                totalCashInput.value = '';
                financingGroup.style.display = 'none';
                btnToggleFinancing.textContent = 'ğŸ’³ ØªÙ…ÙˆÙŠÙ„';
                document.getElementById('employeeId').value = currentEmployee.employee_id;
                document.getElementById('employeeId').readOnly = true;
                document.getElementById('branch').value = currentEmployee.branch_name || '';
                document.getElementById('branch').readOnly = true;
                document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
                result.classList.remove('show');
            } catch (err) {
                console.error('Error saving data:', err);
                console.error('Error details:', {
                    message: err.message,
                    code: err.code,
                    details: err.details,
                    hint: err.hint
                });
                let errorMessage = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Supabase.\n\n';
                if (err.code === 'PGRST116') {
                    errorMessage += 'âŒ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø© Ù„Ø§ ØªØ·Ø§Ø¨Ù‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\n';
                    errorMessage += 'ØªØ­Ù‚Ù‚ Ù…Ù†: Ø§Ù„ØªØ±Ù…ÙŠØ² ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡.';
                } else if (err.code === 'PGRST') {
                    errorMessage += 'âŒ Ø®Ø·Ø£ ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ (RLS).\n';
                    errorMessage += 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ Supabase.';
                } else if (err.message.includes('duplicate key')) {
                    errorMessage += 'âŒ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.';
                } else {
                    errorMessage += `âŒ ${err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
                }
                alert(errorMessage);
            }
        });

        async function handleLogin() {
            const id = loginEmployeeId.value.trim();
            const pass = loginPassword.value.trim();
            if (!id || !pass) {
                alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }
            try {
                const { data: empData, error } = await supabase
                    .from('employees')
                    .select('*')
                    .eq('employee_id', id)
                    .eq('password', pass)
                    .single();
                
                if (error || !empData) {
                    alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    return;
                }
                const data = empData;
                currentEmployee = { id: data.id, ...data };
                loginStatus.textContent = `Ù…Ø³Ø¬Ù„ ÙƒÙ€ ${data.name} - ÙØ±Ø¹: ${data.branch_name || '-'}`;
                loginStatus.style.color = '#28a745';
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
                document.getElementById('welcomeUserName').textContent = data.name;
                document.getElementById('welcomeUserBranch').textContent = data.branch_name || '-';
                welcomeCard.style.display = 'block';
                
                // Ø¹Ø±Ø¶ Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡
                const adminBtn = document.getElementById('btnAdminLink');
                if (data.permissions && data.permissions.includes('manageEmployees')) {
                    adminBtn.style.display = 'inline-block';
                } else {
                    adminBtn.style.display = 'none';
                }
                
                document.getElementById('employeeId').value = data.employee_id;
                document.getElementById('employeeId').readOnly = true;
                document.getElementById('branch').value = data.branch_name || '';
                document.getElementById('branch').readOnly = true;
                setFormEnabled(true);
                secureArea.style.display = 'block';
                loginCard.style.display = 'none';
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
            }
        }

        async function bootstrapAccessIfEmpty() {
            try {
                const { data: employees, error } = await supabase
                    .from('employees')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                
                if (!employees || employees.length === 0) {
                    currentEmployee = { id: 'bootstrap', name: 'Setup Mode', branch_name: '' };
                    loginStatus.textContent = 'ÙˆØ¶Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø­Ø³Ø§Ø¨ (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸ÙÙŠÙ†)';
                    loginStatus.style.color = '#f39c12';
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    document.getElementById('welcomeUserName').textContent = 'Setup Mode';
                    document.getElementById('welcomeUserBranch').textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹';
                    welcomeCard.style.display = 'block';
                    
                    secureArea.style.display = 'block';
                    loginCard.style.display = 'none';
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
        btnLogoutWelcome.addEventListener('click', function() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                currentEmployee = null;
                loginStatus.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„';
                loginStatus.style.color = '#666';
                welcomeCard.style.display = 'none';
                secureArea.style.display = 'none';
                loginCard.style.display = 'block';
                loginEmployeeId.value = '';
                loginPassword.value = '';
                form.reset();
                setFormEnabled(false);
            }
        });

        form.addEventListener('reset', function() {
            result.classList.remove('show');
            if (cardBreakdownGroup) {
                cardBreakdownGroup.style.display = 'none';
            }
            if (otherDetailsGroup) {
                otherDetailsGroup.style.display = 'none';
            }
            if (expenseNotesGroup) expenseNotesGroup.style.display = 'none';
            if (returnsNotesGroup) returnsNotesGroup.style.display = 'none';
            if (withdrawalNotesGroup) withdrawalNotesGroup.style.display = 'none';
            if (expenseNotesInput) expenseNotesInput.value = '';
            if (returnsNotesInput) returnsNotesInput.value = '';
            if (withdrawalNotesInput) withdrawalNotesInput.value = '';
            if (visaSalesInput) visaSalesInput.value = '';
            if (masterSalesInput) masterSalesInput.value = '';
            if (madaSalesInput) madaSalesInput.value = '';
            if (totalCardInput) totalCardInput.value = '';
        });

        btnLogin.addEventListener('click', handleLogin);
        setFormEnabled(false);

        // ===== Ù…Ø¹Ø§Ù„Ø¬ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Supabase Storage =====
        // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©
        imageUploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB');
                imageUploadInput.value = '';
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('âŒ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù…: JPG, PNG, GIF, WEBP');
                imageUploadInput.value = '';
                return;
            }

            uploadedImageFile = file;

            // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø©
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imageName.textContent = `ğŸ“ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                imagePreviewDiv.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        // Ø¹Ù†Ø¯ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©
        btnRemoveImage.addEventListener('click', function() {
            uploadedImageFile = null;
            imageUploadInput.value = '';
            imagePreviewDiv.style.display = 'none';
            previewImg.src = '';
            imageName.textContent = '';
            attachmentInput.value = '';
            attachmentURLInput.value = '';
        });

        // Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Supabase Storage
        async function uploadImageToSupabase(file) {
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ù„Ù
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = `sales-images/${fileName}`;

                console.log('Uploading image to Supabase Storage:', filePath);

                // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Storage
                const { data, error } = await supabase.storage
                    .from('sales-attachments')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    console.error('Upload error:', error);
                    throw error;
                }

                console.log('Upload successful:', data);

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù…
                const { data: urlData } = supabase.storage
                    .from('sales-attachments')
                    .getPublicUrl(filePath);

                console.log('Public URL:', urlData.publicUrl);

                return {
                    fileName: fileName,
                    filePath: filePath,
                    url: urlData.publicUrl
                };
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Google Drive Integration
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù€ Client ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Google Cloud Console
        const GOOGLE_CLIENT_ID = '1035871153322-blaqsn0jds9at16k1ucpeoa0f4vce073.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyDnZ2dkhtkouVaRIw4Pi1krSeFS71e8jGg';
        let pickerInited = false;
        let gauth;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµØ­ÙŠØ­
        function checkGoogleDriveSetup() {
            if (GOOGLE_CLIENT_ID.includes('YOUR_') || GOOGLE_API_KEY.includes('YOUR_')) {
                console.warn('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Google Drive!');
                alert('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¨ÙŠØ§Ù†Ø§Øª Google Drive Ù„Ù… ØªÙØ­Ø¯Ù‘Ø« Ø¨Ø¹Ø¯!\n\nØ§Ù‚Ø±Ø£ Ù…Ù„Ù: FIX_AUTHORIZATION_ERROR.md');
            } else {
                console.log('âœ… Ø¨ÙŠØ§Ù†Ø§Øª Google Drive Ù…Ø­Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }
        }


    
        secureArea.style.display = 'none';
        bootstrapAccessIfEmpty();
    </script>

    <footer style="position:fixed;bottom:0;left:0;right:0;text-align:center;padding:15px;background:#f8f9fa;border-top:2px solid #e0e0e0;color:#666;font-size:14px;">
        Â© 2026 Copy Right by Mazen Algarne. All rights reserved.
    </footer>
</body>
</html>