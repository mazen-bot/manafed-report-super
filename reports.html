<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <link rel="stylesheet" href="reports-style.css">
</head>
<body>
    <div class="reports-container">
        <div style="text-align:center;margin-bottom:20px;">
            <img src="logo.png" alt="Logo" style="height:80px;width:auto;">
        </div>
        <div class="header">
            <h1>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
            <a href="index.html" class="btn-back">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="loginSection" class="card" style="max-width:500px;margin:20px auto;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0;">
            <h2 style="text-align:center;margin-bottom:16px;color:#333;">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
            <div style="margin-bottom:12px;">
                <label style="display:block;margin-bottom:6px;font-weight:600;color:#555;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                <input type="text" id="loginEmployeeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;">
            </div>
            <div style="margin-bottom:12px;">
                <label style="display:block;margin-bottom:6px;font-weight:600;color:#555;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                <input type="password" id="loginPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;">
            </div>
            <button id="btnLogin" style="width:100%;padding:14px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:transform 0.2s;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <div id="loginMessage" style="margin-top:12px;text-align:center;color:#666;font-weight:600;"></div>
        </div>

        <div id="reportsContent" style="display:none;">
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="card" style="margin-bottom:20px;padding:16px;background:#e8f5e9;border-radius:12px;border:2px solid #4caf50;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
                    <div>
                        <strong style="color:#2e7d32;font-size:16px;">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong>
                        <span id="currentUserName" style="color:#1b5e20;font-weight:600;margin-right:8px;"></span>
                        <span style="color:#666;margin-right:8px;">|</span>
                        <strong style="color:#2e7d32;">ğŸ¢ Ø§Ù„ÙØ±Ø¹:</strong>
                        <span id="currentUserBranch" style="color:#1b5e20;font-weight:600;margin-right:8px;"></span>
                    </div>
                    <button id="btnLogout" style="padding:8px 16px;background:#d32f2f;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
                <div id="userPermissionsInfo" style="margin-top:10px;color:#666;font-size:13px;"></div>
            </div>

        <div class="filters-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠØŒ Ø§Ù„ÙØ±Ø¹ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®...)">
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filterBranch">ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹:</label>
                    <select id="filterBranch">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterDateFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="filterDateFrom" style="padding:8px;border:2px solid #3498db;border-radius:8px;">
                </div>

                <div class="filter-group">
                    <label for="filterDateTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="filterDateTo" style="padding:8px;border:2px solid #3498db;border-radius:8px;">
                </div>

                <button class="btn-reset-filter" onclick="resetFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                <button class="btn-export" onclick="exportToExcel()" id="btnExport">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                <button class="btn-clear-all" onclick="clearAllData()" id="btnClearAll" style="display:none;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
            
            <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <button class="btn-filter-special" onclick="filterByExpenses()" style="background:linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);color:white;padding:10px 20px;border:none;border-radius:10px;font-weight:700;cursor:pointer;transition:transform 0.2s;box-shadow:0 4px 6px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    ğŸ’¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙ‚Ø·
                </button>
                <button class="btn-filter-special" onclick="showCardBreakdownReport()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:10px 20px;border:none;border-radius:10px;font-weight:700;cursor:pointer;transition:transform 0.2s;box-shadow:0 4px 6px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    ğŸ“Š ØªÙ‚Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©
                </button>
                <button class="btn-filter-special" id="btnShowAll" onclick="showAllRecords()" style="background:linear-gradient(135deg, #27ae60 0%, #229954 100%);color:white;padding:10px 20px;border:none;border-radius:10px;font-weight:700;cursor:pointer;transition:transform 0.2s;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:none;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    ğŸ“Š Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                </button>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                <div class="stat-value" id="totalRecords">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                <div class="stat-value" id="totalSalesSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´</div>
                <div class="stat-value" id="totalCashSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ</div>
                <div class="stat-value" id="totalCardSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
            <div class="stat-card stat-expenses">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                <div class="stat-value" id="totalExpensesSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
            <div class="stat-card stat-withdrawals">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</div>
                <div class="stat-value" id="totalWithdrawalsSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
        </div>

        <!-- Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ© -->
        <div class="stats-cards" id="cardBreakdownStats" style="display:none;margin-top:15px;border:3px solid #3498db;border-radius:12px;padding:15px;background:#e3f2fd;">
            <h3 style="text-align:center;color:#1976d2;margin-bottom:15px;font-size:18px;">ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©</h3>
            <div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">
                <div class="stat-card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:none;">
                    <div class="stat-label" style="color:#fff;">ğŸ’³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠØ²Ø§</div>
                    <div class="stat-value" id="totalVisaSum" style="color:#fff;">0 Ø±ÙŠØ§Ù„</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);color:white;border:none;">
                    <div class="stat-label" style="color:#fff;">ğŸ’³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§Ø³ØªØ± ÙƒØ§Ø±Ø¯</div>
                    <div class="stat-value" id="totalMasterSum" style="color:#fff;">0 Ø±ÙŠØ§Ù„</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);color:white;border:none;">
                    <div class="stat-label" style="color:#fff;">ğŸ’³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯Ù‰</div>
                    <div class="stat-value" id="totalMadaSum" style="color:#fff;">0 Ø±ÙŠØ§Ù„</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);color:white;border:none;">
                    <div class="stat-label" style="color:#fff;">ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                    <div class="stat-value" id="totalCardRecords" style="color:#fff;">0</div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="reportsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                        <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                        <th>Ø§Ù„ÙƒØ§Ø´</th>
                        <th>Ù…Ø¯ÙŠ</th>
                        <th class="card-breakdown-col" style="background:#f60000;"> ÙÙŠØ²Ø§</th>
                        <th class="card-breakdown-col" style="background:#eec008;"> Ù…Ø§Ø³ØªØ±</th>
                        <th class="card-breakdown-col" style="background:#03dbf7;"> Ù…Ø¯Ù‰</th>
                        <th>ØªÙ…Ø§Ø±Ø§</th>
                        <th>ØªØ§Ø¨ÙŠ</th>
                        <th>ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯</th>
                        <th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th>
                        <th>Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯</th>
                        <th>Ø§Ù„Ø³Ø­Ø¨</th>
                        <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚</th>
                        <th id="actionsHeader">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr class="no-data">
                        <td colspan="13">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div> <!-- Ù†Ù‡Ø§ÙŠØ© reportsContent -->
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const supabaseUrl = 'https://rgblfimktfasocahzqtg.supabase.co'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù€ URL Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnYmxmaW1rdGZhc29jYWh6cXRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDg5NTQsImV4cCI6MjA4NTUyNDk1NH0.BMKXS1hTX5ntacnOQH5c2I5KDp5jpSWwJeHIDkz2els'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù€ key Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        let allData = [];
        let currentUser = null;

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('btnLogin').addEventListener('click', async function() {
            const employeeId = document.getElementById('loginEmployeeId').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const loginMessage = document.getElementById('loginMessage');

            if (!employeeId || !password) {
                loginMessage.textContent = 'âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
                loginMessage.style.color = '#d32f2f';
                return;
            }

            try {
                console.log('Attempting login with:', { employeeId, password });
                
                const { data: empData, error } = await supabase
                    .from('employees')
                    .select('*')
                    .eq('employee_id', employeeId)
                    .eq('password', password);

                console.log('Query result:', { empData, error });

                if (error) {
                    console.error('Supabase error:', error);
                    const errorText = error.message || error.details || error.hint || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    loginMessage.textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${errorText}`;
                    loginMessage.style.color = '#d32f2f';
                    return;
                }

                if (!empData || empData.length === 0) {
                    loginMessage.textContent = 'âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                    loginMessage.style.color = '#d32f2f';
                    return;
                }

                const employeeData = empData[0];
                currentUser = {
                    id: employeeData.id,
                    employee_id: employeeData.employee_id,
                    name: employeeData.name,
                    branch_id: employeeData.branch_id,
                    branch_name: employeeData.branch_name,
                    permissions: employeeData.permissions || []
                };

                // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©
                localStorage.setItem('reportsSession', JSON.stringify({
                    user: currentUser,
                    timestamp: Date.now()
                }));

                loginMessage.textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­';
                loginMessage.style.color = '#4caf50';

                setTimeout(() => {
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('reportsContent').style.display = 'block';
                    initializeReports();
                }, 500);

            } catch (err) {
                console.error(err);
                loginMessage.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                loginMessage.style.color = '#d32f2f';
            }
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById('btnLogout').addEventListener('click', function() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('reportsSession');
                currentUser = null;
                document.getElementById('reportsContent').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('loginEmployeeId').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginMessage').textContent = '';
            }
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        async function checkExistingSession() {
            const sessionData = localStorage.getItem('reportsSession');
            if (sessionData) {
                try {
                    const { user, timestamp } = JSON.parse(sessionData);
                    const elapsed = Date.now() - timestamp;
                    const oneHour = 60 * 60 * 1000;

                    if (elapsed < oneHour) {
                        currentUser = user;
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('reportsContent').style.display = 'block';
                        await initializeReports();
                        return;
                    } else {
                        localStorage.removeItem('reportsSession');
                    }
                } catch (err) {
                    console.error(err);
                    localStorage.removeItem('reportsSession');
                }
            }
        }

        async function initializeReports() {
            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserBranch').textContent = currentUser.branch_name;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
            const hasViewReports = currentUser.permissions.includes('viewReports');
            const hasManageEmployees = currentUser.permissions.includes('manageEmployees');
            const hasExport = currentUser.permissions.includes('export');

            let permissionsText = 'ğŸ“‹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: ';
            if (hasViewReports) permissionsText += 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ';
            if (hasManageEmployees) permissionsText += '| Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© ';
            if (hasExport) permissionsText += '| ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ';
            document.getElementById('userPermissionsInfo').textContent = permissionsText;

            // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
            if (!hasManageEmployees) {
                // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
                document.getElementById('btnClearAll').style.display = 'none';
                // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                document.getElementById('actionsHeader').style.display = 'none';
            } else {
                document.getElementById('btnClearAll').style.display = 'inline-block';
                document.getElementById('actionsHeader').style.display = 'table-cell';
            }

            if (!hasExport) {
                document.getElementById('btnExport').style.display = 'none';
            }

            await loadData();
        }

        window.onload = function() {
            checkExistingSession();
        };

        async function loadData() {
            try {
                const { data: records, error } = await supabase
                    .from('sales')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allData = (records || []).map(data => {
                    const createdAt = data.created_at ? new Date(data.created_at) : new Date();
                    return {
                        id: data.id,
                        employeeId: data.employee_id,
                        branch: data.branch,
                        saleDate: data.sale_date,
                        totalSales: data.total_sales,
                        totalCash: data.total_cash,
                        totalCard: data.total_card,
                        visaSales: data.visa_sales,
                        masterSales: data.master_sales,
                        madaSales: data.mada_sales,
                        tamara: data.tamara,
                        tabby: data.tabby,
                        extraCash: data.extra_cash,
                        expenses: data.expenses,
                        returns: data.returns,
                        withdrawal: data.withdrawal,
                        notes: data.notes,
                        financingNotes: data.financing_notes,
                        attachment: data.attachment,
                        createdAt
                    };
                });

                // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ ÙØ±Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù
                if (currentUser && !currentUser.permissions.includes('manageEmployees')) {
                    // Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙˆÙ† ÙŠØ±ÙˆÙ† ÙÙ‚Ø· ØªÙ‚Ø§Ø±ÙŠØ± ÙØ±Ø¹Ù‡Ù…
                    allData = allData.filter(record => record.branch === currentUser.branch_name);
                }

                displayData(allData);
                updateStats(allData);
                populateBranchFilter();
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
            }
        }

        function displayData(data) {
            const tableBody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr class="no-data"><td colspan="17">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td></tr>';
                return;
            }

            const hasManagePermission = currentUser && currentUser.permissions.includes('manageEmployees');

            tableBody.innerHTML = '';
            data.forEach((record, index) => {
                const row = document.createElement('tr');
                const financingNotes = record.financingNotes && record.financingNotes !== '-' ? record.financingNotes : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª';
                const tamaraTooltip = (record.tamara && record.tamara > 0) ? `title="Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${financingNotes}" style="cursor:help;"` : '';
                const tabbyTooltip = (record.tabby && record.tabby > 0) ? `title="Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${financingNotes}" style="cursor:help;"` : '';
                
                // ØªØ­Ø¯ÙŠØ¯ Ù…Ø­ØªÙˆÙ‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                let actionsCell = '';
                if (hasManagePermission) {
                    actionsCell = `
                        <td>
                            <button class="btn-view" onclick="viewDetails('${record.id}')">ğŸ‘ï¸</button>
                            <button class="btn-delete" onclick="deleteRecord('${record.id}')">ğŸ—‘ï¸</button>
                        </td>
                    `;
                } else {
                    actionsCell = `
                        <td style="display:none;">
                            <button class="btn-view" onclick="viewDetails('${record.id}')">ğŸ‘ï¸</button>
                        </td>
                    `;
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${record.saleDate || '-'}</td>
                    <td>${formatDateTime(record.createdAt)}</td>
                    <td>${record.employeeId}</td>
                    <td>${record.branch}</td>
                    <td>${parseFloat(record.totalSales).toFixed(2)}</td>
                    <td>${parseFloat(record.totalCash).toFixed(2)}</td>
                    <td>${parseFloat(record.totalCard).toFixed(2)}</td>
                    <td class="card-breakdown-col" style="background:#e3f2fd;">${record.visaSales ? parseFloat(record.visaSales).toFixed(2) : '0.00'}</td>
                    <td class="card-breakdown-col" style="background:#fce4ec;">${record.masterSales ? parseFloat(record.masterSales).toFixed(2) : '0.00'}</td>
                    <td class="card-breakdown-col" style="background:#e0f7fa;">${record.madaSales ? parseFloat(record.madaSales).toFixed(2) : '0.00'}</td>
                    <td ${tamaraTooltip}>${parseFloat(record.tamara || 0).toFixed(2)}</td>
                    <td ${tabbyTooltip}>${parseFloat(record.tabby || 0).toFixed(2)}</td>
                    <td>${parseFloat(record.extraCash || 0).toFixed(2)}</td>
                    <td>${parseFloat(record.expenses).toFixed(2)}</td>
                    <td>${parseFloat(record.returns).toFixed(2)}</td>
                    <td>${parseFloat(record.withdrawal).toFixed(2)}</td>
                    <td class="notes-cell">${record.notes || '-'}</td>
                    <td>${getAttachmentCell(record)}</td>
                    ${actionsCell}
                `;
                tableBody.appendChild(row);
            });
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const dateStr = date.toLocaleDateString('ar-EG');
            const timeStr = date.toLocaleTimeString('ar-EG');
            return `${dateStr}<br>${timeStr}`;
        }

        function getAttachmentCell(record) {
            if (record.attachment && record.attachment !== '-' && record.attachment.startsWith('http')) {
                return `<a href="${record.attachment}" target="_blank" style="color:#4caf50;text-decoration:none;font-weight:600;">ğŸ–¼ï¸ Ø¹Ø±Ø¶</a>`;
            }
            return 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        }

        function updateStats(data) {
            document.getElementById('totalRecords').textContent = data.length;
            
            const totalSales = data.reduce((sum, record) => sum + parseFloat(record.totalSales || 0), 0);
            const totalCash = data.reduce((sum, record) => sum + parseFloat(record.totalCash || 0), 0);
            const totalCard = data.reduce((sum, record) => sum + parseFloat(record.totalCard || 0), 0);
            const totalExpenses = data.reduce((sum, record) => sum + parseFloat(record.expenses || 0), 0);
            const totalWithdrawals = data.reduce((sum, record) => sum + parseFloat(record.withdrawal || 0), 0);
            
            document.getElementById('totalSalesSum').textContent = totalSales.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalCashSum').textContent = totalCash.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalCardSum').textContent = totalCard.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalExpensesSum').textContent = totalExpenses.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalWithdrawalsSum').textContent = totalWithdrawals.toFixed(2) + ' Ø±ÙŠØ§Ù„';
        }

        function populateBranchFilter() {
            const filterBranch = document.getElementById('filterBranch');
            
            // Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†ØŒ Ø¥Ø®ÙØ§Ø¡ ÙÙ„ØªØ± Ø§Ù„ÙØ±Ø¹ Ù„Ø£Ù†Ù‡Ù… ÙŠØ±ÙˆÙ† ÙØ±Ø¹Ù‡Ù… ÙÙ‚Ø·
            if (currentUser && !currentUser.permissions.includes('manageEmployees')) {
                filterBranch.closest('.filter-group').style.display = 'none';
                return;
            }

            const branches = [...new Set(allData.map(record => record.branch))];
            filterBranch.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                filterBranch.appendChild(option);
            });
        }

        document.getElementById('searchInput').addEventListener('input', function() {
            applyFilters();
        });

        document.getElementById('filterBranch').addEventListener('change', function() {
            applyFilters();
        });

        document.getElementById('filterDateFrom').addEventListener('change', function() {
            applyFilters();
        });

        document.getElementById('filterDateTo').addEventListener('change', function() {
            applyFilters();
        });

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedBranch = document.getElementById('filterBranch').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            let filteredData = allData.filter(record => {
                const matchesSearch = searchTerm === '' || 
                    record.employeeId.toLowerCase().includes(searchTerm) ||
                    record.branch.toLowerCase().includes(searchTerm) ||
                    (record.notes && record.notes.toLowerCase().includes(searchTerm));

                const matchesBranch = selectedBranch === '' || record.branch === selectedBranch;

                let matchesDate = true;
                if (dateFrom || dateTo) {
                    const recordDate = record.saleDate || new Date(record.createdAt).toISOString().split('T')[0];
                    if (dateFrom && dateTo) {
                        matchesDate = recordDate >= dateFrom && recordDate <= dateTo;
                    } else if (dateFrom) {
                        matchesDate = recordDate >= dateFrom;
                    } else if (dateTo) {
                        matchesDate = recordDate <= dateTo;
                    }
                }

                return matchesSearch && matchesBranch && matchesDate;
            });

            displayData(filteredData);
            updateStats(filteredData);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterBranch').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø£Ø¹Ù…Ø¯Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            document.body.classList.remove('card-breakdown-view');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
            document.getElementById('cardBreakdownStats').style.display = 'none';
            
            document.getElementById('btnShowAll').style.display = 'none';
            displayData(allData);
            updateStats(allData);
        }

        window.resetFilters = resetFilters;

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙØ§Øª
        function filterByExpenses() {
            const filteredData = allData.filter(record => {
                const expenses = parseFloat(record.expenses || 0);
                return expenses > 0;
            });
            
            if (filteredData.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙØ§Øª');
                return;
            }
            
            document.getElementById('btnShowAll').style.display = 'inline-block';
            displayData(filteredData);
            updateStats(filteredData);
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
            const totalExpenses = filteredData.reduce((sum, record) => sum + parseFloat(record.expenses || 0), 0);
            console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ ${filteredData.length} Ø¹Ù…Ù„ÙŠØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${totalExpenses.toFixed(2)} Ø±ÙŠØ§Ù„`);
        }

        window.filterByExpenses = filterByExpenses;

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø´Ø¨ÙƒØ©
        function filterByTotalCard() {
            const filteredData = allData.filter(record => {
                const totalCard = parseFloat(record.totalCard || 0);
                return totalCard > 0;
            });
            
            if (filteredData.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø´Ø¨ÙƒØ©');
                return;
            }
            
            document.getElementById('btnShowAll').style.display = 'inline-block';
            displayData(filteredData);
            updateStats(filteredData);
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
            const totalCard = filteredData.reduce((sum, record) => sum + parseFloat(record.totalCard || 0), 0);
            console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ ${filteredData.length} Ø¹Ù…Ù„ÙŠØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø´Ø¨ÙƒØ© Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${totalCard.toFixed(2)} Ø±ÙŠØ§Ù„`);
        }

        window.filterByTotalCard = filterByTotalCard;

        // Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ø¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠØ²Ø§ ÙˆÙ…Ø§Ø³ØªØ± ÙƒØ§Ø±Ø¯ ÙˆÙ…Ø¯Ù‰
        function showCardBreakdownReport() {
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø´Ø¨ÙƒØ©
            const filteredData = allData.filter(record => {
                const totalCard = parseFloat(record.totalCard || 0);
                return totalCard > 0;
            });
            
            if (filteredData.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø´Ø¨ÙƒØ©');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªÙØ§ØµÙŠÙ„ Ù…Ù†ÙØµÙ„Ø©
            const hasBreakdownDetails = filteredData.some(record => {
                const visa = parseFloat(record.visaSales || 0);
                const master = parseFloat(record.masterSales || 0);
                const mada = parseFloat(record.madaSales || 0);
                return (visa > 0 || master > 0 || mada > 0);
            });
            
            if (!hasBreakdownDetails) {
                alert('â„¹ï¸ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø¨ÙƒØ©.\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ÙØµÙ„Ø© (ÙÙŠØ²Ø§ØŒ Ù…Ø§Ø³ØªØ±ØŒ Ù…Ø¯Ù‰) Ø³ØªØ¸Ù‡Ø± 0.00 Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„.');
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¹Ù…Ø¯Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ø¨Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©
            document.body.classList.add('card-breakdown-view');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
            document.getElementById('cardBreakdownStats').style.display = 'block';
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
            const totalVisa = filteredData.reduce((sum, record) => sum + parseFloat(record.visaSales || 0), 0);
            const totalMaster = filteredData.reduce((sum, record) => sum + parseFloat(record.masterSales || 0), 0);
            const totalMada = filteredData.reduce((sum, record) => sum + parseFloat(record.madaSales || 0), 0);
            
            // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('totalVisaSum').textContent = totalVisa.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalMasterSum').textContent = totalMaster.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalMadaSum').textContent = totalMada.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalCardRecords').textContent = filteredData.length;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
            document.getElementById('btnShowAll').style.display = 'inline-block';
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
            displayData(filteredData);
            updateStats(filteredData);
            
            console.log(`âœ… ØªÙ‚Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©: ${filteredData.length} Ø¹Ù…Ù„ÙŠØ©`);
            console.log(`   ğŸ’³ ÙÙŠØ²Ø§: ${totalVisa.toFixed(2)} Ø±ÙŠØ§Ù„`);
            console.log(`   ğŸ’³ Ù…Ø§Ø³ØªØ± ÙƒØ§Ø±Ø¯: ${totalMaster.toFixed(2)} Ø±ÙŠØ§Ù„`);
            console.log(`   ğŸ’³ Ù…Ø¯Ù‰: ${totalMada.toFixed(2)} Ø±ÙŠØ§Ù„`);
        }

        window.showCardBreakdownReport = showCardBreakdownReport;

        // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ø©)
        function showAllRecords() {
            // Ø¥Ø®ÙØ§Ø¡ Ø£Ø¹Ù…Ø¯Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ø¨Ø± Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø©
            document.body.classList.remove('card-breakdown-view');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
            document.getElementById('cardBreakdownStats').style.display = 'none';
            
            document.getElementById('btnShowAll').style.display = 'none';
            displayData(allData);
            updateStats(allData);
        }

        window.showAllRecords = showAllRecords;

        function viewDetails(id) {
            const record = allData.find(r => r.id === id);
            if (!record) return;
            
            let attachmentInfo = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            if (record.attachment && record.attachment !== '-' && record.attachment.startsWith('http')) {
                attachmentInfo = `âœ… ÙŠÙˆØ¬Ø¯ ØµÙˆØ±Ø©\nØ±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©: ${record.attachment}\n\n(Ø§Ø¶ØºØ· OK Ø«Ù… Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©)`;
            }
            
            alert(`
ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${record.saleDate || '-'}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(record.createdAt).toLocaleString('ar-EG')}
Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ: ${record.employeeId}
Ø§Ù„ÙØ±Ø¹: ${record.branch}
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${record.totalSales} Ø±ÙŠØ§Ù„
Ø§Ù„ÙƒØ§Ø´: ${record.totalCash} Ø±ÙŠØ§Ù„
Ù…Ø¯ÙŠ: ${record.totalCard} Ø±ÙŠØ§Ù„
ØªÙ…Ø§Ø±Ø§: ${record.tamara || 0} Ø±ÙŠØ§Ù„
ØªØ§Ø¨ÙŠ: ${record.tabby || 0} Ø±ÙŠØ§Ù„
ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯: ${record.extraCash || 0} Ø±ÙŠØ§Ù„
Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${record.expenses} Ø±ÙŠØ§Ù„
Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯: ${record.returns} Ø±ÙŠØ§Ù„
Ø§Ù„Ø³Ø­Ø¨: ${record.withdrawal} Ø±ÙŠØ§Ù„
Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${record.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}
Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚: ${attachmentInfo}
            `);
        }

        window.viewDetails = viewDetails;

        async function deleteRecord(id) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
            if (!currentUser || !currentUser.permissions.includes('manageEmployees')) {
                alert('â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª');
                return;
            }

            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
            try {
                const { error } = await supabase
                    .from('sales')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                allData = allData.filter(r => r.id !== id);
                displayData(allData);
                updateStats(allData);
                populateBranchFilter();
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Supabase.');
            }
        }

        window.deleteRecord = deleteRecord;

        async function clearAllData() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
            if (!currentUser || !currentUser.permissions.includes('manageEmployees')) {
                alert('â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }

            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) return;
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª!')) return;
            try {
                const ids = allData.map(r => r.id);
                await Promise.all(ids.map(id => 
                    supabase
                        .from('sales')
                        .delete()
                        .eq('id', id)
                ));
                
                allData = [];
                displayData(allData);
                updateStats(allData);
                populateBranchFilter();
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Supabase.');
            }
        }

        window.clearAllData = clearAllData;

        function exportToExcel() {
            if (allData.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            let csv = '\uFEFF';
            csv += 'Ø§Ù„Ø±Ù‚Ù…,ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ,Ø§Ù„ÙØ±Ø¹,Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª,Ø§Ù„ÙƒØ§Ø´,Ù…Ø¯ÙŠ,ØªÙ…Ø§Ø±Ø§,ØªØ§Ø¨ÙŠ,ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯,Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª,Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯,Ø§Ù„Ø³Ø­Ø¨,Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª,Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚\n';

            allData.forEach((record, index) => {
                const date = new Date(record.createdAt);
                csv += `${index + 1},`;
                csv += `${record.saleDate || '-'},`;
                csv += `${date.toLocaleDateString('ar-EG')},`;
                csv += `${date.toLocaleTimeString('ar-EG')},`;
                csv += `${record.employeeId},`;
                csv += `${record.branch},`;
                csv += `${record.totalSales},`;
                csv += `${record.totalCash},`;
                csv += `${record.totalCard},`;
                csv += `${record.tamara || 0},`;
                csv += `${record.tabby || 0},`;
                csv += `${record.extraCash || 0},`;
                csv += `${record.expenses},`;
                csv += `${record.returns},`;
                csv += `${record.withdrawal},`;
                csv += `"${record.notes || '-'}",`;
                csv += `${record.attachment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `sales_report_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.exportToExcel = exportToExcel;
    </script>

    <footer style="position:fixed;bottom:0;left:0;right:0;text-align:center;padding:15px;background:#f8f9fa;border-top:2px solid #e0e0e0;color:#666;font-size:14px;">
        Â© 2026 Copy Right by Mazen Algarne. All rights reserved.
    </footer>
</body>
</html>
